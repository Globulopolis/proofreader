/** Proofreader v3.0.0 https://github.com/Globulopolis/proofreader; License: GPL-2.0-or-later */
(a=>{a.fn.proofreader=function(e,t){let n=this,c={initialized:!1,selectionObject:{},scripts:[]},l=a.extend({loadFormUrl:null,messagesContainerSelector:"#proofreader_messages_container",typoContainerSelector:"#proofreader_typo_container",typoTextElementSelector:"#proofreader_typo_text",typoPrefixElementSelector:"#proofreader_typo_prefix",typoSuffixElementSelector:"#proofreader_typo_suffix",highlightClass:"proofreader_highlight",messageErrorClass:"proofreader_message_error",popupMessageErrorClass:"proofreader_popup_message_error",popupMessageSuccessClass:"proofreader_popup_message_success",floatingButtonClass:"proofreader_mouse",floatingButtonOffset:15,floatingButtonDelay:2e3,highlightTypos:!1,selectionMaxLength:100,showWordsBefore:10,showWordsAfter:10,handlerType:"keyboard"},e),o=a.extend({reportTypo:"Report a typo",thankYou:"Thank you for reporting the typo!",browserIsNotSupported:"Your browser does not support selection handling.",selectionIsTooLarge:"You have selected too large text block!"},t);return c.init=function(){c.clearSelectionObject(),n.find("form").length&&c.initForm(),"keyboard"!==l.handlerType&&"both"!==l.handlerType||c.addKeyboardEvents(),"mouse"!==l.handlerType&&"both"!==l.handlerType||c.addSelectionEvents()},c.initForm=function(){var e;c.$form=n.find("form").first(),c.$form.length&&(c.$messagesContainer=a(l.messagesContainerSelector),c.$typoContainer=a(l.typoContainerSelector),c.$typoTextElement=a(l.typoTextElementSelector),c.$typoPrefixElement=a(l.typoPrefixElementSelector),c.$typoSuffixElement=a(l.typoSuffixElementSelector),e=a("#proofreaderModal .modal-footer"),c.$closeButton=e.find("button[data-bs-dismiss]"),c.$submitButton=e.find('button[type="submit"]'),c.$submitButton.on("click",function(e){e.preventDefault(),c.submitForm()}),c.$form.on("submit",function(e){e.preventDefault(),c.submitForm()}),document.getElementById("proofreaderModal").addEventListener("hidden.bs.modal",function(){c.hideProofreader()}),c.initialized=!0)},c.loadForm=function(o){Joomla.request({url:l.loadFormUrl,data:{page_url:encodeURI(window.location.href),page_title:a(document).find("title").text()},onSuccess:e=>{try{var t=JSON.parse(e);t.success?c.isValidFormResponse(t.data.form)?(c.replaceForm(t.data.form),c.injectScripts(t.data.scripts,t.data.script).done(function(){void 0!==o&&o()})):c.hideProofreader():c.showMessage(t.message,"danger",!0)}catch(e){return c.showMessage(e,"danger",!0),!1}},onError:t=>{try{var e=JSON.parse(t.response);c.showMessage(e.message,"danger",!0)}catch(e){c.showMessage(t.statusText,"danger",!0)}},onComplete:()=>{c.$submitButton.removeAttr("disabled")}})},c.addKeyboardEvents=function(){let o=!1;a(document).keyup(function(e){17===e.which&&(o=!1)}).keydown(function(e){var t;return 27===e.which?(t=document.getElementById("proofreaderToast"),t=bootstrap.Toast.getInstance(t),n.is(":visible")?c.hideProofreader():t.isShown()&&c.resetMessagePopup(),!1):!0!==(o=17===e.which||o)||13!==e.which||n.is(":visible")?void 0:(c.removeFloatingButton(),c.refreshSelectionObject(),c.showProofreader(),!1)})},c.addSelectionEvents=function(){a("body").on("mouseup",function(e){c.isSubmitButtonClick(e)||(c.removeFloatingButton(),c.refreshSelectionObject(),c.canShowProofreader()&&c.createFloatingButton(e))})},c.injectScript=function(e){a("head").append(a("<script>",{type:"text/javascript",text:e}))},c.injectScripts=function(e,t){let o=[],n=a.Deferred();return e&&(a.each(e,function(e,t){-1!==a.inArray(t,c.scripts)||a('script[src="'+t+'"]').length||o.push(a.ajax({url:t,dataType:"script",success:function(){c.scripts.push(t)}}))}),t)&&""!==t?o.length?a.when.apply(a,o).done(function(){c.injectScript(t),n.resolve()}):(c.injectScript(t),n.resolve()):n.resolve(),n.promise()},c.canShowProofreader=function(){var e=document.getElementById("proofreaderToast"),e=bootstrap.Toast.getInstance(e);return!(""===c.selectionObject.text||n.is(":visible")||e.isShown())},c.showProofreader=function(){if(c.canShowProofreader())if(c.selectionObject.text.length>l.selectionMaxLength)n.is(":visible")?c.showMessage(o.selectionIsTooLarge,l.popupMessageErrorClass):c.showMessage(o.selectionIsTooLarge,l.popupMessageErrorClass,!0);else{if(c.initialized)c.showForm();else{if(!l.loadFormUrl)return;c.loadForm(c.showForm)}n.show()}},c.hideProofreader=function(){c.clearSelectionObject(),c.updateFormHiddenFields(),n.hide()},c.showForm=function(){c.initialized&&(c.$form.trigger("reset"),c.removeFormMessages(),c.renderFormTypoContainer(),c.updateFormHiddenFields(),c.$submitButton.length)&&c.$submitButton.removeAttr("disabled");var e=new bootstrap.Modal("#proofreaderModal"),t=document.getElementById("proofreaderModal");e.show(t)},c.submitForm=function(){if(!document.formvalidator.isValid(document.getElementById("proofreaderForm")))return c.showMessage(Joomla.Text._("JLIB_FORM_CONTAINS_INVALID_FIELDS"),"danger"),!1;Joomla.request({url:c.$form.attr("action"),method:"POST",data:c.$form.serialize(),onBefore:()=>{c.removeMessage(),c.$submitButton.attr("disabled","disabled")},onSuccess:e=>{e=JSON.parse(e);e.success?(c.$closeButton.trigger("click"),c.isValidFormResponse(e.data.form)&&(c.replaceForm(e.data.form),c.injectScripts(e.data.scripts,e.data.script)),l.highlightTypos&&c.highlightTypo(a(".proofreader_highlight"),c.$form.find("#proofreader_typo_text").val()),c.showMessage(o.thankYou,"success",!0),c.clearSelectionObject()):c.showMessage(e.message,"danger")},onError:t=>{c.$closeButton.trigger("click");try{var e=JSON.parse(t.response);c.showMessage(e.message,"danger",!0)}catch(e){c.showMessage(t.statusText,"danger",!0)}},onComplete:()=>{c.$submitButton.removeAttr("disabled")}})},c.replaceForm=function(e){n.find("form").remove().end().show().append(e),c.initForm(),a.each(c.$form.find("label"),function(e,t){a(t).removeAttr("title")}),c.$form.find("button").focus()},c.isSubmitButtonClick=function(e){return"submit"===a(e.target).attr("type")},c.resetMessagePopup=function(){var e=document.getElementById("proofreaderToast");bootstrap.Toast.getInstance(e).hide()},c.createFloatingButton=function(e){e=c.getMousePosition(e);c.$floatingButton=a("<div>",{text:o.reportTypo,class:l.floatingButtonClass}).css({position:"absolute",top:e.y+l.floatingButtonOffset+"px",left:e.x+l.floatingButtonOffset+"px"}).on("mouseup",function(){return c.showProofreader(),c.renderFormTypoContainer(),a(this).remove(),!1}).appendTo(a("body")),c.floatingButtonTimer=setTimeout(function(){void 0!==c.$floatingButton&&c.$floatingButton.remove()},l.floatingButtonDelay)},c.removeFloatingButton=function(){void 0!==c.floatingButtonTimer&&clearInterval(c.floatingButtonTimer),void 0!==c.$floatingButton&&c.$floatingButton.remove()},c.updateFormHiddenFields=function(){c.$typoTextElement.length&&c.$typoTextElement.val(c.selectionObject.text),c.$typoPrefixElement.length&&c.$typoPrefixElement.val(c.selectionObject.prefix),c.$typoSuffixElement.length&&c.$typoSuffixElement.val(c.selectionObject.suffix)},c.renderFormTypoContainer=function(){c.initialized&&c.$typoContainer.length&&(c.$typoContainer.html(""),""!==c.selectionObject.prefix&&c.$typoContainer.append(a("<span>",{text:c.selectionObject.prefix})),c.$typoContainer.append(a("<mark>",{text:c.selectionObject.text,"data-markjs":!0})),""!==c.selectionObject.suffix)&&c.$typoContainer.append(a("<span>",{text:c.selectionObject.suffix}))},c.renderFormMessages=function(e){c.initialized&&c.$messagesContainer.length&&(c.removeFormMessages(),a.each(e,function(e,t){c.$messagesContainer.append(a("<div>",{text:t,class:l.messageErrorClass}))}))},c.removeFormMessages=function(){var e=c.$messagesContainer.find("div.alert");c.initialized&&e.length&&bootstrap.Alert.getOrCreateInstance(e).close()},c.highlightTypo=function(e,t){let o,n,r="",s="";""!==t&&e.length&&"body"!==e.prop("tagName").toLowerCase()&&(o=t.split(" "),a.each(o,function(e,t){r=r+"(<[^>]+>)?(\\s)?("+t.replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")+")(\\s)?",s=s+"$"+(4*e+1)+"$"+(4*e+2)+'<mark data-markjs="true">$'+(4*e+3)+"</mark>$"+(4*e+4)}),""!==(n=e.html().replace(new RegExp(r,"g"),s)))&&e.html(n)},c.showMessage=function(o,n,r){if(c.resetMessagePopup(),c.removeMessage(),c.removeFloatingButton(),r){var r=document.getElementById("proofreaderToast"),s=("success"===n?(r.classList.remove("text-bg-danger"),r.classList.add("text-bg-success")):"danger"===n&&(r.classList.remove("text-bg-success"),r.classList.add("text-bg-danger")),bootstrap.Toast.getInstance(r));a(r).find(".toast-body").text(o),s.show()}else{r=document.getElementById("proofreader_messages_container");let e="",t="ms-3";"danger"===n?e='<span class="icon icon-cancel-circle"></span>':"warning"===n?e='<span class="icon exclamation-triangle"></span>':t="",a("#proofreader_messages_container .alert").is(":visible")||((s=document.createElement("div")).innerHTML=['<div class="alert alert-'+n+' alert-dismissible d-flex align-items-center" role="alert">',e+'   <div class="'+t+'">'+o+"</div>",'   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',"</div>"].join(""),r?r.append(s):c.showMessage(o,n,!0))}},c.removeMessage=function(e){let t;(t=e instanceof HTMLElement?e:void 0===e||e&&"#proofreader_messages_container"===e?document.getElementById("proofreader_messages_container"):document.querySelector(e))&&t.querySelectorAll(":scope div").length&&c.removeFormMessages()},c.createSelectionObject=function(e,t,o,n){return{text:e,prefix:t,suffix:o,node:n}},c.clearSelectionObject=function(){c.selectionObject=c.createSelectionObject("","","")},c.refreshSelectionObject=function(){window.getSelection?c.selectionObject=c.getWebKitSelection():document.getSelection?c.selectionObject=c.getGeckoSelection():document.selection?c.selectionObject=c.getTridentSelection():(c.clearSelectionObject(),c.showMessage(o.browserIsNotSupported,l.popupMessageErrorClass,!0)),""===c.selectionObject.text&&c.clearSelectionObject()},c.getRangeText=function(e){let t=e.cloneContents(),o=document.createElement("div"),n,r;for(;t.firstChild;)o.appendChild(t.firstChild);for(n=a(o).find("script,style,form"),r=n.length;r--;)n[r].parentNode.removeChild(n[r]);for(;o.firstChild;)t.appendChild(o.firstChild);return t.textContent},c.getSelectionContainer=function(e){for(;e;){if(1===e.nodeType)return e;e=e.parentNode}},c.getWebKitSelection=function(){let e=window.getSelection(),t="",o="",n="",r,s,a,i;return e&&0<e.rangeCount&&(t=e.toString(),s=e.getRangeAt(0),r=c.getSelectionContainer(s.commonAncestorContainer),(a=s.cloneRange()).setStartBefore(s.startContainer.ownerDocument.body),a.setEnd(s.startContainer,s.startOffset),o=c.truncateText(c.getRangeText(a),-l.showWordsBefore),(i=s.cloneRange()).setStart(s.endContainer,s.endOffset),i.setEndAfter(s.endContainer.ownerDocument.body),n=c.truncateText(c.getRangeText(i),l.showWordsAfter)),c.createSelectionObject(t,o,n,r)},c.getGeckoSelection=function(){var e=document.getSelection().toString();return c.createSelectionObject(e,"","")},c.getTridentSelection=function(){var e=document.selection,t=e.createRange,o=t.text,t=c.getSelectionContainer(t.parentElement()),n=e.createRange(),e=e.createRange();return n.moveStart("word",-l.showWordsBefore),n.moveEnd("character",-o.length),e.moveStart("character",o.length),e.moveEnd("word",l.showWordsAfter),c.createSelectionObject(o,n.text,e.text,t)},c.getMousePosition=function(e){var t={x:0,y:0};return e&&(e.pageX||e.pageY?(t.x=e.pageX,t.y=e.pageY):(e.clientX||e.clientY)&&(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop)),t},c.truncateText=function(e,t){let o=e.replace(/(\r|\n|\t)+/g," ").replace(/(\s)+/g," ").split(" ").filter(Boolean),n=Math.min(o.length,Math.abs(t)),r="";return r=0<t?(e.match(/^\s/g)?" ":"")+o.slice(0,n).join(" "):o.slice(o.length-n).join(" ")+(e.match(/\s$/g)?" ":"")},c.isValidFormResponse=function(e){return e&&0<a("<div>"+e+"</div>").find("form").length},c.init(),n}})(jQuery);